---
layout: default
title: "Journal API"
categories:
  - api
---
   <div class="row-fluid">     <div class="page-title documentation-page-title">       <div class="container">         <h1 class="page-title__title">API Documentation</h1>         <a href="https://github.com/noflo/noflo/blob/master/src/lib/Journal.coffee" class="btn btn-primary page-title__button big-button">On GitHub</a>       </div>     </div>   </div>    <div class="row-fluid">     <div class="container documentation-main-container">       <div class="main">         <div class="sidebar span4">                    <nav>             <ul class="sidebar__nav">                                                                  <li>                   <a {% if page.url == '/api/ArrayPort/index.html' %}class="active" {% endif %}href="/api/ArrayPort/">                     ArrayPort                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/AsyncComponent/index.html' %}class="active" {% endif %}href="/api/AsyncComponent/">                     AsyncComponent                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/BasePort/index.html' %}class="active" {% endif %}href="/api/BasePort/">                     BasePort                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/Component/index.html' %}class="active" {% endif %}href="/api/Component/">                     Component                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/ComponentLoader/index.html' %}class="active" {% endif %}href="/api/ComponentLoader/">                     ComponentLoader                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/Graph/index.html' %}class="active" {% endif %}href="/api/Graph/">                     Graph                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/Helpers/index.html' %}class="active" {% endif %}href="/api/Helpers/">                     Helpers                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/IP/index.html' %}class="active" {% endif %}href="/api/IP/">                     IP                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/InPort/index.html' %}class="active" {% endif %}href="/api/InPort/">                     InPort                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/InternalSocket/index.html' %}class="active" {% endif %}href="/api/InternalSocket/">                     InternalSocket                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/Journal/index.html' %}class="active" {% endif %}href="/api/Journal/">                     Journal                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/Network/index.html' %}class="active" {% endif %}href="/api/Network/">                     Network                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/NoFlo/index.html' %}class="active" {% endif %}href="/api/NoFlo/">                     NoFlo                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/OutPort/index.html' %}class="active" {% endif %}href="/api/OutPort/">                     OutPort                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/Platform/index.html' %}class="active" {% endif %}href="/api/Platform/">                     Platform                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/Port/index.html' %}class="active" {% endif %}href="/api/Port/">                     Port                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/Ports/index.html' %}class="active" {% endif %}href="/api/Ports/">                     Ports                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/Streams/index.html' %}class="active" {% endif %}href="/api/Streams/">                     Streams                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/Utils/index.html' %}class="active" {% endif %}href="/api/Utils/">                     Utils                   </a>                 </li>                                             </ul>           </nav>                  </div>         <div class="content span8">           <h1>{{ page.title }}</h1>                                     <pre><code>NoFlo - Flow-Based Programming for JavaScript
(c) 2016 TheGrid (Rituwall Inc.)
(c) 2014 Jon Nordby
(c) 2013 TheGrid (Rituwall Inc.)
(c) 2011-2012 Henri Bergius, Nemein
NoFlo may be freely distributed under the MIT license
</code></pre>                            <div class="highlight"><pre><span class="p">{</span><span class="nx">EventEmitter</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&#39;events&#39;</span>

<span class="nv">clone = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;./Utils&#39;</span><span class="p">).</span><span class="nx">clone</span>

<span class="nv">entryToPrettyString = </span><span class="nf">(entry) -&gt;</span>
  <span class="nv">a = </span><span class="nx">entry</span><span class="p">.</span><span class="nx">args</span>
  <span class="k">return</span> <span class="k">switch</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">cmd</span>
    <span class="k">when</span> <span class="s">&#39;addNode&#39;</span> <span class="k">then</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="s">(</span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">component</span><span class="si">}</span><span class="s">)&quot;</span>
    <span class="k">when</span> <span class="s">&#39;removeNode&#39;</span> <span class="k">then</span> <span class="s">&quot;DEL </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="s">(</span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">component</span><span class="si">}</span><span class="s">)&quot;</span>
    <span class="k">when</span> <span class="s">&#39;renameNode&#39;</span> <span class="k">then</span> <span class="s">&quot;RENAME </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">oldId</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">newId</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">when</span> <span class="s">&#39;changeNode&#39;</span> <span class="k">then</span> <span class="s">&quot;META </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">when</span> <span class="s">&#39;addEdge&#39;</span> <span class="k">then</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">node</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">port</span><span class="si">}</span><span class="s"> -&gt; </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">port</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">node</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">when</span> <span class="s">&#39;removeEdge&#39;</span> <span class="k">then</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">node</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">port</span><span class="si">}</span><span class="s"> -X&gt; </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">port</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">node</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">when</span> <span class="s">&#39;changeEdge&#39;</span> <span class="k">then</span> <span class="s">&quot;META </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">node</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">port</span><span class="si">}</span><span class="s"> -&gt; </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">port</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">node</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">when</span> <span class="s">&#39;addInitial&#39;</span> <span class="k">then</span> <span class="s">&quot;&#39;</span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">data</span><span class="si">}</span><span class="s">&#39; -&gt; </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">port</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">node</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">when</span> <span class="s">&#39;removeInitial&#39;</span> <span class="k">then</span> <span class="s">&quot;&#39;</span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">data</span><span class="si">}</span><span class="s">&#39; -X&gt; </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">port</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">node</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">when</span> <span class="s">&#39;startTransaction&#39;</span> <span class="k">then</span> <span class="s">&quot;&gt;&gt;&gt; </span><span class="si">#{</span><span class="nx">entry</span><span class="p">.</span><span class="nx">rev</span><span class="si">}</span><span class="s">: </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">when</span> <span class="s">&#39;endTransaction&#39;</span> <span class="k">then</span> <span class="s">&quot;&lt;&lt;&lt; </span><span class="si">#{</span><span class="nx">entry</span><span class="p">.</span><span class="nx">rev</span><span class="si">}</span><span class="s">: </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">when</span> <span class="s">&#39;changeProperties&#39;</span> <span class="k">then</span> <span class="s">&quot;PROPERTIES&quot;</span>
    <span class="k">when</span> <span class="s">&#39;addGroup&#39;</span> <span class="k">then</span> <span class="s">&quot;GROUP </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">when</span> <span class="s">&#39;renameGroup&#39;</span> <span class="k">then</span> <span class="s">&quot;RENAME GROUP </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">oldName</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">newName</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">when</span> <span class="s">&#39;removeGroup&#39;</span> <span class="k">then</span> <span class="s">&quot;DEL GROUP </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">when</span> <span class="s">&#39;changeGroup&#39;</span> <span class="k">then</span> <span class="s">&quot;META GROUP </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">when</span> <span class="s">&#39;addInport&#39;</span> <span class="k">then</span> <span class="s">&quot;INPORT </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">when</span> <span class="s">&#39;removeInport&#39;</span> <span class="k">then</span> <span class="s">&quot;DEL INPORT </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">when</span> <span class="s">&#39;renameInport&#39;</span> <span class="k">then</span> <span class="s">&quot;RENAME INPORT </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">oldId</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">newId</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">when</span> <span class="s">&#39;changeInport&#39;</span> <span class="k">then</span> <span class="s">&quot;META INPORT </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">when</span> <span class="s">&#39;addOutport&#39;</span> <span class="k">then</span> <span class="s">&quot;OUTPORT </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">when</span> <span class="s">&#39;removeOutport&#39;</span> <span class="k">then</span> <span class="s">&quot;DEL OUTPORT </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">when</span> <span class="s">&#39;renameOutport&#39;</span> <span class="k">then</span> <span class="s">&quot;RENAME OUTPORT </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">oldId</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">newId</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">when</span> <span class="s">&#39;changeOutport&#39;</span> <span class="k">then</span> <span class="s">&quot;META OUTPORT </span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&quot;Unknown journal entry: </span><span class="si">#{</span><span class="nx">entry</span><span class="p">.</span><span class="nx">cmd</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span></pre></div>                                                  <p>To set, not just update (append) metadata</p>                            <div class="highlight"><pre><span class="nv">calculateMeta = </span><span class="nf">(oldMeta, newMeta) -&gt;</span>
  <span class="nv">setMeta = </span><span class="p">{}</span>
  <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">oldMeta</span>
    <span class="nx">setMeta</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span>
  <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">newMeta</span>
    <span class="nx">setMeta</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>
  <span class="k">return</span> <span class="nx">setMeta</span>


<span class="k">class</span> <span class="nx">JournalStore</span> <span class="k">extends</span> <span class="nx">EventEmitter</span>
  <span class="nv">lastRevision: </span><span class="mi">0</span>
  <span class="nv">constructor: </span><span class="nf">(@graph) -&gt;</span>
    <span class="vi">@lastRevision = </span><span class="mi">0</span>
  <span class="nv">putTransaction: </span><span class="nf">(revId, entries) -&gt;</span>
    <span class="vi">@lastRevision = </span><span class="nx">revId</span> <span class="k">if</span> <span class="nx">revId</span> <span class="o">&gt;</span> <span class="nx">@lastRevision</span>
    <span class="nx">@emit</span> <span class="s">&#39;transaction&#39;</span><span class="p">,</span> <span class="nx">revId</span>
  <span class="nv">fetchTransaction: </span><span class="nf">(revId, entries) -&gt;</span>

<span class="k">class</span> <span class="nx">MemoryJournalStore</span> <span class="k">extends</span> <span class="nx">JournalStore</span>
  <span class="nv">constructor: </span><span class="nf">(graph) -&gt;</span>
    <span class="k">super</span> <span class="nx">graph</span>
    <span class="vi">@transactions = </span><span class="p">[]</span>

  <span class="nv">putTransaction: </span><span class="nf">(revId, entries) -&gt;</span>
    <span class="k">super</span> <span class="nx">revId</span><span class="p">,</span> <span class="nx">entries</span>
    <span class="nx">@transactions</span><span class="p">[</span><span class="nx">revId</span><span class="p">]</span> <span class="o">=</span> <span class="nx">entries</span>

  <span class="nv">fetchTransaction: </span><span class="nf">(revId) -&gt;</span>
    <span class="k">return</span> <span class="nx">@transactions</span><span class="p">[</span><span class="nx">revId</span><span class="p">]</span></pre></div>                                                  <h2>Journalling graph changes</h2>

<p>The Journal can follow graph changes, store them
and allows to recall previous revisions of the graph.</p>

<p>Revisions stored in the journal follow the transactions of the graph.
It is not possible to operate on smaller changes than individual transactions.
Use startTransaction and endTransaction on Graph to structure the revisions logical changesets.</p>                            <div class="highlight"><pre><span class="k">class</span> <span class="nx">Journal</span> <span class="k">extends</span> <span class="nx">EventEmitter</span>
  <span class="nv">graph: </span><span class="kc">null</span>
  <span class="nv">entries: </span><span class="p">[]</span> <span class="c1"># Entries added during this revision</span>
  <span class="nv">subscribed: </span><span class="kc">true</span> <span class="c1"># Whether we should respond to graph change notifications or not</span>

  <span class="nv">constructor: </span><span class="nf">(graph, metadata, store) -&gt;</span>
    <span class="vi">@graph = </span><span class="nx">graph</span>
    <span class="vi">@entries = </span><span class="p">[]</span>
    <span class="vi">@subscribed = </span><span class="kc">true</span>
    <span class="vi">@store = </span><span class="nx">store</span> <span class="o">||</span> <span class="k">new</span> <span class="nx">MemoryJournalStore</span> <span class="nx">@graph</span>

    <span class="k">if</span> <span class="nx">@store</span><span class="p">.</span><span class="nx">transactions</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span></pre></div>                                                  <p>Sync journal with current graph to start transaction history</p>                            <div class="highlight"><pre>      <span class="vi">@currentRevision = </span><span class="o">-</span><span class="mi">1</span>
      <span class="nx">@startTransaction</span> <span class="s">&#39;initial&#39;</span><span class="p">,</span> <span class="nx">metadata</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;addNode&#39;</span><span class="p">,</span> <span class="nx">node</span> <span class="k">for</span> <span class="nx">node</span> <span class="k">in</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">nodes</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;addEdge&#39;</span><span class="p">,</span> <span class="nx">edge</span> <span class="k">for</span> <span class="nx">edge</span> <span class="k">in</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">edges</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;addInitial&#39;</span><span class="p">,</span> <span class="nx">iip</span> <span class="k">for</span> <span class="nx">iip</span> <span class="k">in</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">initializers</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;changeProperties&#39;</span><span class="p">,</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">properties</span><span class="p">,</span> <span class="p">{}</span> <span class="k">if</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">@graph</span><span class="p">.</span><span class="nx">properties</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;addInport&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">name: </span><span class="nx">k</span><span class="p">,</span> <span class="nv">port: </span><span class="nx">v</span><span class="p">}</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span><span class="nx">v</span> <span class="k">of</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">inports</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;addOutport&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">name: </span><span class="nx">k</span><span class="p">,</span> <span class="nv">port: </span><span class="nx">v</span><span class="p">}</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span><span class="nx">v</span> <span class="k">of</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">outports</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;addGroup&#39;</span><span class="p">,</span> <span class="nx">group</span> <span class="k">for</span> <span class="nx">group</span> <span class="k">in</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">groups</span>
      <span class="nx">@endTransaction</span> <span class="s">&#39;initial&#39;</span><span class="p">,</span> <span class="nx">metadata</span>
    <span class="k">else</span></pre></div>                                                  <p>Persistent store, start with its latest rev</p>                            <div class="highlight"><pre>      <span class="vi">@currentRevision = </span><span class="nx">@store</span><span class="p">.</span><span class="nx">lastRevision</span></pre></div>                                                  <p>Subscribe to graph changes</p>                            <div class="highlight"><pre>    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;addNode&#39;</span><span class="p">,</span> <span class="nf">(node) =&gt;</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;addNode&#39;</span><span class="p">,</span> <span class="nx">node</span>
    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;removeNode&#39;</span><span class="p">,</span> <span class="nf">(node) =&gt;</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;removeNode&#39;</span><span class="p">,</span> <span class="nx">node</span>
    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;renameNode&#39;</span><span class="p">,</span> <span class="nf">(oldId, newId) =&gt;</span>
      <span class="nv">args =</span>
        <span class="nv">oldId: </span><span class="nx">oldId</span>
        <span class="nv">newId: </span><span class="nx">newId</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;renameNode&#39;</span><span class="p">,</span> <span class="nx">args</span>
    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;changeNode&#39;</span><span class="p">,</span> <span class="nf">(node, oldMeta) =&gt;</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;changeNode&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">id: </span><span class="nx">node</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="k">new</span><span class="o">:</span> <span class="nx">node</span><span class="p">.</span><span class="nx">metadata</span><span class="p">,</span> <span class="nv">old: </span><span class="nx">oldMeta</span><span class="p">}</span>
    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;addEdge&#39;</span><span class="p">,</span> <span class="nf">(edge) =&gt;</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;addEdge&#39;</span><span class="p">,</span> <span class="nx">edge</span>
    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;removeEdge&#39;</span><span class="p">,</span> <span class="nf">(edge) =&gt;</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;removeEdge&#39;</span><span class="p">,</span> <span class="nx">edge</span>
    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;changeEdge&#39;</span><span class="p">,</span> <span class="nf">(edge, oldMeta) =&gt;</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;changeEdge&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">from: </span><span class="nx">edge</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nv">to: </span><span class="nx">edge</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span> <span class="k">new</span><span class="o">:</span> <span class="nx">edge</span><span class="p">.</span><span class="nx">metadata</span><span class="p">,</span> <span class="nv">old: </span><span class="nx">oldMeta</span><span class="p">}</span>
    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;addInitial&#39;</span><span class="p">,</span> <span class="nf">(iip) =&gt;</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;addInitial&#39;</span><span class="p">,</span> <span class="nx">iip</span>
    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;removeInitial&#39;</span><span class="p">,</span> <span class="nf">(iip) =&gt;</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;removeInitial&#39;</span><span class="p">,</span> <span class="nx">iip</span>

    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;changeProperties&#39;</span><span class="p">,</span> <span class="nf">(newProps, oldProps) =&gt;</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;changeProperties&#39;</span><span class="p">,</span> <span class="p">{</span><span class="k">new</span><span class="o">:</span> <span class="nx">newProps</span><span class="p">,</span> <span class="nv">old: </span><span class="nx">oldProps</span><span class="p">}</span>

    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;addGroup&#39;</span><span class="p">,</span> <span class="nf">(group) =&gt;</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;addGroup&#39;</span><span class="p">,</span> <span class="nx">group</span>
    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;renameGroup&#39;</span><span class="p">,</span> <span class="nf">(oldName, newName) =&gt;</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;renameGroup&#39;</span><span class="p">,</span>
        <span class="nv">oldName: </span><span class="nx">oldName</span>
        <span class="nv">newName: </span><span class="nx">newName</span>
    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;removeGroup&#39;</span><span class="p">,</span> <span class="nf">(group) =&gt;</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;removeGroup&#39;</span><span class="p">,</span> <span class="nx">group</span>
    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;changeGroup&#39;</span><span class="p">,</span> <span class="nf">(group, oldMeta) =&gt;</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;changeGroup&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">name: </span><span class="nx">group</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="k">new</span><span class="o">:</span> <span class="nx">group</span><span class="p">.</span><span class="nx">metadata</span><span class="p">,</span> <span class="nv">old: </span><span class="nx">oldMeta</span><span class="p">}</span>

    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;addExport&#39;</span><span class="p">,</span> <span class="nf">(exported) =&gt;</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;addExport&#39;</span><span class="p">,</span> <span class="nx">exported</span>
    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;removeExport&#39;</span><span class="p">,</span> <span class="nf">(exported) =&gt;</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;removeExport&#39;</span><span class="p">,</span> <span class="nx">exported</span>

    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;addInport&#39;</span><span class="p">,</span> <span class="nf">(name, port) =&gt;</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;addInport&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">name: </span><span class="nx">name</span><span class="p">,</span> <span class="nv">port: </span><span class="nx">port</span><span class="p">}</span>
    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;removeInport&#39;</span><span class="p">,</span> <span class="nf">(name, port) =&gt;</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;removeInport&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">name: </span><span class="nx">name</span><span class="p">,</span> <span class="nv">port: </span><span class="nx">port</span><span class="p">}</span>
    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;renameInport&#39;</span><span class="p">,</span> <span class="nf">(oldId, newId) =&gt;</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;renameInport&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">oldId: </span><span class="nx">oldId</span><span class="p">,</span> <span class="nv">newId: </span><span class="nx">newId</span><span class="p">}</span>
    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;changeInport&#39;</span><span class="p">,</span> <span class="nf">(name, port, oldMeta) =&gt;</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;changeInport&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">name: </span><span class="nx">name</span><span class="p">,</span> <span class="k">new</span><span class="o">:</span> <span class="nx">port</span><span class="p">.</span><span class="nx">metadata</span><span class="p">,</span> <span class="nv">old: </span><span class="nx">oldMeta</span><span class="p">}</span>
    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;addOutport&#39;</span><span class="p">,</span> <span class="nf">(name, port) =&gt;</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;addOutport&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">name: </span><span class="nx">name</span><span class="p">,</span> <span class="nv">port: </span><span class="nx">port</span><span class="p">}</span>
    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;removeOutport&#39;</span><span class="p">,</span> <span class="nf">(name, port) =&gt;</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;removeOutport&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">name: </span><span class="nx">name</span><span class="p">,</span> <span class="nv">port: </span><span class="nx">port</span><span class="p">}</span>
    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;renameOutport&#39;</span><span class="p">,</span> <span class="nf">(oldId, newId) =&gt;</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;renameOutport&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">oldId: </span><span class="nx">oldId</span><span class="p">,</span> <span class="nv">newId: </span><span class="nx">newId</span><span class="p">}</span>
    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;changeOutport&#39;</span><span class="p">,</span> <span class="nf">(name, port, oldMeta) =&gt;</span>
      <span class="nx">@appendCommand</span> <span class="s">&#39;changeOutport&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">name: </span><span class="nx">name</span><span class="p">,</span> <span class="k">new</span><span class="o">:</span> <span class="nx">port</span><span class="p">.</span><span class="nx">metadata</span><span class="p">,</span> <span class="nv">old: </span><span class="nx">oldMeta</span><span class="p">}</span>

    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;startTransaction&#39;</span><span class="p">,</span> <span class="nf">(id, meta) =&gt;</span>
      <span class="nx">@startTransaction</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">meta</span>
    <span class="nx">@graph</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;endTransaction&#39;</span><span class="p">,</span> <span class="nf">(id, meta) =&gt;</span>
      <span class="nx">@endTransaction</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">meta</span>

  <span class="nv">startTransaction: </span><span class="nf">(id, meta) =&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@subscribed</span>
    <span class="k">if</span> <span class="nx">@entries</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&quot;Inconsistent @entries&quot;</span><span class="p">)</span>
    <span class="nx">@currentRevision</span><span class="o">++</span>
    <span class="nx">@appendCommand</span> <span class="s">&#39;startTransaction&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">id: </span><span class="nx">id</span><span class="p">,</span> <span class="nv">metadata: </span><span class="nx">meta</span><span class="p">},</span> <span class="nx">@currentRevision</span>

  <span class="nv">endTransaction: </span><span class="nf">(id, meta) =&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@subscribed</span>

    <span class="nx">@appendCommand</span> <span class="s">&#39;endTransaction&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">id: </span><span class="nx">id</span><span class="p">,</span> <span class="nv">metadata: </span><span class="nx">meta</span><span class="p">},</span> <span class="nx">@currentRevision</span></pre></div>                                                  <p>TODO: this would be the place to refine @entries into
a minimal set of changes, like eliminating changes early in transaction
which were later reverted/overwritten</p>                            <div class="highlight"><pre>    <span class="nx">@store</span><span class="p">.</span><span class="nx">putTransaction</span> <span class="nx">@currentRevision</span><span class="p">,</span> <span class="nx">@entries</span>
    <span class="vi">@entries = </span><span class="p">[]</span>

  <span class="nv">appendCommand: </span><span class="nf">(cmd, args, rev) -&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@subscribed</span>

    <span class="nv">entry =</span>
      <span class="nv">cmd: </span><span class="nx">cmd</span>
      <span class="nv">args: </span><span class="nx">clone</span> <span class="nx">args</span>
    <span class="nv">entry.rev = </span><span class="nx">rev</span> <span class="k">if</span> <span class="nx">rev</span><span class="o">?</span>
    <span class="nx">@entries</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">entry</span><span class="p">)</span>

  <span class="nv">executeEntry: </span><span class="nf">(entry) -&gt;</span>
    <span class="nv">a = </span><span class="nx">entry</span><span class="p">.</span><span class="nx">args</span>
    <span class="k">switch</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">cmd</span>
      <span class="k">when</span> <span class="s">&#39;addNode&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">addNode</span> <span class="nx">a</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">component</span>
      <span class="k">when</span> <span class="s">&#39;removeNode&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">removeNode</span> <span class="nx">a</span><span class="p">.</span><span class="nx">id</span>
      <span class="k">when</span> <span class="s">&#39;renameNode&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">renameNode</span> <span class="nx">a</span><span class="p">.</span><span class="nx">oldId</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">newId</span>
      <span class="k">when</span> <span class="s">&#39;changeNode&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">setNodeMetadata</span> <span class="nx">a</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">calculateMeta</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">old</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">new</span><span class="p">)</span>
      <span class="k">when</span> <span class="s">&#39;addEdge&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">addEdge</span> <span class="nx">a</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">port</span>
      <span class="k">when</span> <span class="s">&#39;removeEdge&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">removeEdge</span> <span class="nx">a</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">port</span>
      <span class="k">when</span> <span class="s">&#39;changeEdge&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">setEdgeMetadata</span> <span class="nx">a</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">calculateMeta</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">old</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">new</span><span class="p">)</span>
      <span class="k">when</span> <span class="s">&#39;addInitial&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">addInitial</span> <span class="nx">a</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">port</span>
      <span class="k">when</span> <span class="s">&#39;removeInitial&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">removeInitial</span> <span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">port</span>
      <span class="k">when</span> <span class="s">&#39;startTransaction&#39;</span> <span class="k">then</span> <span class="kc">null</span>
      <span class="k">when</span> <span class="s">&#39;endTransaction&#39;</span> <span class="k">then</span> <span class="kc">null</span>
      <span class="k">when</span> <span class="s">&#39;changeProperties&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">setProperties</span> <span class="nx">a</span><span class="p">.</span><span class="nx">new</span>
      <span class="k">when</span> <span class="s">&#39;addGroup&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">addGroup</span> <span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">nodes</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">metadata</span>
      <span class="k">when</span> <span class="s">&#39;renameGroup&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">renameGroup</span> <span class="nx">a</span><span class="p">.</span><span class="nx">oldName</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">newName</span>
      <span class="k">when</span> <span class="s">&#39;removeGroup&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">removeGroup</span> <span class="nx">a</span><span class="p">.</span><span class="nx">name</span>
      <span class="k">when</span> <span class="s">&#39;changeGroup&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">setGroupMetadata</span> <span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">calculateMeta</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">old</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">new</span><span class="p">)</span>
      <span class="k">when</span> <span class="s">&#39;addInport&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">addInport</span> <span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">process</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">metadata</span>
      <span class="k">when</span> <span class="s">&#39;removeInport&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">removeInport</span> <span class="nx">a</span><span class="p">.</span><span class="nx">name</span>
      <span class="k">when</span> <span class="s">&#39;renameInport&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">renameInport</span> <span class="nx">a</span><span class="p">.</span><span class="nx">oldId</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">newId</span>
      <span class="k">when</span> <span class="s">&#39;changeInport&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">setInportMetadata</span> <span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">calculateMeta</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">old</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">new</span><span class="p">)</span>
      <span class="k">when</span> <span class="s">&#39;addOutport&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">addOutport</span> <span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">process</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">metadata</span> <span class="nx">a</span><span class="p">.</span><span class="nx">name</span>
      <span class="k">when</span> <span class="s">&#39;removeOutport&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">removeOutport</span>
      <span class="k">when</span> <span class="s">&#39;renameOutport&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">renameOutport</span> <span class="nx">a</span><span class="p">.</span><span class="nx">oldId</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">newId</span>
      <span class="k">when</span> <span class="s">&#39;changeOutport&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">setOutportMetadata</span> <span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">calculateMeta</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">old</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">new</span><span class="p">)</span>
      <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&quot;Unknown journal entry: </span><span class="si">#{</span><span class="nx">entry</span><span class="p">.</span><span class="nx">cmd</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>

  <span class="nv">executeEntryInversed: </span><span class="nf">(entry) -&gt;</span>
    <span class="nv">a = </span><span class="nx">entry</span><span class="p">.</span><span class="nx">args</span>
    <span class="k">switch</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">cmd</span>
      <span class="k">when</span> <span class="s">&#39;addNode&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">removeNode</span> <span class="nx">a</span><span class="p">.</span><span class="nx">id</span>
      <span class="k">when</span> <span class="s">&#39;removeNode&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">addNode</span> <span class="nx">a</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">component</span>
      <span class="k">when</span> <span class="s">&#39;renameNode&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">renameNode</span> <span class="nx">a</span><span class="p">.</span><span class="nx">newId</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">oldId</span>
      <span class="k">when</span> <span class="s">&#39;changeNode&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">setNodeMetadata</span> <span class="nx">a</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">calculateMeta</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">new</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">old</span><span class="p">)</span>
      <span class="k">when</span> <span class="s">&#39;addEdge&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">removeEdge</span> <span class="nx">a</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">port</span>
      <span class="k">when</span> <span class="s">&#39;removeEdge&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">addEdge</span> <span class="nx">a</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">port</span>
      <span class="k">when</span> <span class="s">&#39;changeEdge&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">setEdgeMetadata</span> <span class="nx">a</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">calculateMeta</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">new</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">old</span><span class="p">)</span>
      <span class="k">when</span> <span class="s">&#39;addInitial&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">removeInitial</span> <span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">port</span>
      <span class="k">when</span> <span class="s">&#39;removeInitial&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">addInitial</span> <span class="nx">a</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">port</span>
      <span class="k">when</span> <span class="s">&#39;startTransaction&#39;</span> <span class="k">then</span> <span class="kc">null</span>
      <span class="k">when</span> <span class="s">&#39;endTransaction&#39;</span> <span class="k">then</span> <span class="kc">null</span>
      <span class="k">when</span> <span class="s">&#39;changeProperties&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">setProperties</span> <span class="nx">a</span><span class="p">.</span><span class="nx">old</span>
      <span class="k">when</span> <span class="s">&#39;addGroup&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">removeGroup</span> <span class="nx">a</span><span class="p">.</span><span class="nx">name</span>
      <span class="k">when</span> <span class="s">&#39;renameGroup&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">renameGroup</span> <span class="nx">a</span><span class="p">.</span><span class="nx">newName</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">oldName</span>
      <span class="k">when</span> <span class="s">&#39;removeGroup&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">addGroup</span> <span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">nodes</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">metadata</span>
      <span class="k">when</span> <span class="s">&#39;changeGroup&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">setGroupMetadata</span> <span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">calculateMeta</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">new</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">old</span><span class="p">)</span>
      <span class="k">when</span> <span class="s">&#39;addInport&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">removeInport</span> <span class="nx">a</span><span class="p">.</span><span class="nx">name</span>
      <span class="k">when</span> <span class="s">&#39;removeInport&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">addInport</span> <span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">process</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">metadata</span>
      <span class="k">when</span> <span class="s">&#39;renameInport&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">renameInport</span> <span class="nx">a</span><span class="p">.</span><span class="nx">newId</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">oldId</span>
      <span class="k">when</span> <span class="s">&#39;changeInport&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">setInportMetadata</span> <span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">calculateMeta</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">new</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">old</span><span class="p">)</span>
      <span class="k">when</span> <span class="s">&#39;addOutport&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">removeOutport</span> <span class="nx">a</span><span class="p">.</span><span class="nx">name</span>
      <span class="k">when</span> <span class="s">&#39;removeOutport&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">addOutport</span> <span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">process</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">metadata</span>
      <span class="k">when</span> <span class="s">&#39;renameOutport&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">renameOutport</span> <span class="nx">a</span><span class="p">.</span><span class="nx">newId</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">oldId</span>
      <span class="k">when</span> <span class="s">&#39;changeOutport&#39;</span> <span class="k">then</span> <span class="nx">@graph</span><span class="p">.</span><span class="nx">setOutportMetadata</span> <span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">calculateMeta</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">new</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">old</span><span class="p">)</span>
      <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&quot;Unknown journal entry: </span><span class="si">#{</span><span class="nx">entry</span><span class="p">.</span><span class="nx">cmd</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>

  <span class="nv">moveToRevision: </span><span class="nf">(revId) -&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">revId</span> <span class="o">==</span> <span class="nx">@currentRevision</span>

    <span class="vi">@subscribed = </span><span class="kc">false</span>

    <span class="k">if</span> <span class="nx">revId</span> <span class="o">&gt;</span> <span class="nx">@currentRevision</span></pre></div>                                                  <p>Forward replay journal to revId</p>                            <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">r</span> <span class="k">in</span> <span class="p">[</span><span class="nx">@currentRevision</span><span class="o">+</span><span class="mi">1</span><span class="p">..</span><span class="nx">revId</span><span class="p">]</span>
        <span class="nx">@executeEntry</span> <span class="nx">entry</span> <span class="k">for</span> <span class="nx">entry</span> <span class="k">in</span> <span class="nx">@store</span><span class="p">.</span><span class="nx">fetchTransaction</span> <span class="nx">r</span>

    <span class="k">else</span></pre></div>                                                  <p>Move backwards, and apply inverse changes</p>                            <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">r</span> <span class="k">in</span> <span class="p">[</span><span class="nx">@currentRevision</span><span class="p">..</span><span class="nx">revId</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="k">by</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nv">entries = </span><span class="nx">@store</span><span class="p">.</span><span class="nx">fetchTransaction</span> <span class="nx">r</span>
        <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">entries</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">..</span><span class="mi">0</span><span class="p">]</span> <span class="k">by</span> <span class="o">-</span><span class="mi">1</span>
          <span class="nx">@executeEntryInversed</span> <span class="nx">entries</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>

    <span class="vi">@currentRevision = </span><span class="nx">revId</span>
    <span class="vi">@subscribed = </span><span class="kc">true</span></pre></div>                                                  <h2>Undoing &amp; redoing</h2>

<p>Undo the last graph change</p>                            <div class="highlight"><pre>  <span class="nv">undo: </span><span class="nf">() -&gt;</span>
    <span class="k">return</span> <span class="k">unless</span> <span class="nx">@canUndo</span><span class="p">()</span>
    <span class="nx">@moveToRevision</span><span class="p">(</span><span class="nx">@currentRevision</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></pre></div>                                                  <p>If there is something to undo</p>                            <div class="highlight"><pre>  <span class="nv">canUndo: </span><span class="nf">() -&gt;</span>
    <span class="k">return</span> <span class="nx">@currentRevision</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>                                                  <p>Redo the last undo</p>                            <div class="highlight"><pre>  <span class="nv">redo: </span><span class="nf">() -&gt;</span>
    <span class="k">return</span> <span class="k">unless</span> <span class="nx">@canRedo</span><span class="p">()</span>
    <span class="nx">@moveToRevision</span><span class="p">(</span><span class="nx">@currentRevision</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span></pre></div>                                                  <p>If there is something to redo</p>                            <div class="highlight"><pre>  <span class="nv">canRedo: </span><span class="nf">() -&gt;</span>
    <span class="k">return</span> <span class="nx">@currentRevision</span> <span class="o">&lt;</span> <span class="nx">@store</span><span class="p">.</span><span class="nx">lastRevision</span></pre></div>                                                  <h1>Serializing</h1>

<p>Render a pretty printed string of the journal. Changes are abbreviated</p>                            <div class="highlight"><pre>  <span class="nv">toPrettyString: </span><span class="nf">(startRev, endRev) -&gt;</span>
    <span class="nx">startRev</span> <span class="o">|=</span> <span class="mi">0</span>
    <span class="nx">endRev</span> <span class="o">|=</span> <span class="nx">@store</span><span class="p">.</span><span class="nx">lastRevision</span>
    <span class="nv">lines = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">r</span> <span class="k">in</span> <span class="p">[</span><span class="nx">startRev</span><span class="p">...</span><span class="nx">endRev</span><span class="p">]</span>
      <span class="nv">e = </span><span class="nx">@store</span><span class="p">.</span><span class="nx">fetchTransaction</span> <span class="nx">r</span>
      <span class="nx">lines</span><span class="p">.</span><span class="nx">push</span> <span class="p">(</span><span class="nx">entryToPrettyString</span> <span class="nx">entry</span><span class="p">)</span> <span class="k">for</span> <span class="nx">entry</span> <span class="k">in</span> <span class="nx">e</span>
    <span class="k">return</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;\n&#39;</span><span class="p">)</span></pre></div>                                                  <p>Serialize journal to JSON</p>                            <div class="highlight"><pre>  <span class="nv">toJSON: </span><span class="nf">(startRev, endRev) -&gt;</span>
    <span class="nx">startRev</span> <span class="o">|=</span> <span class="mi">0</span>
    <span class="nx">endRev</span> <span class="o">|=</span> <span class="nx">@store</span><span class="p">.</span><span class="nx">lastRevision</span>
    <span class="nv">entries = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">r</span> <span class="k">in</span> <span class="p">[</span><span class="nx">startRev</span><span class="p">...</span><span class="nx">endRev</span><span class="p">]</span> <span class="k">by</span> <span class="mi">1</span>
      <span class="nx">entries</span><span class="p">.</span><span class="nx">push</span> <span class="p">(</span><span class="nx">entryToPrettyString</span> <span class="nx">entry</span><span class="p">)</span> <span class="k">for</span> <span class="nx">entry</span> <span class="k">in</span> <span class="nx">@store</span><span class="p">.</span><span class="nx">fetchTransaction</span> <span class="nx">r</span>
    <span class="k">return</span> <span class="nx">entries</span>

  <span class="nv">save: </span><span class="nf">(file, success) -&gt;</span>
    <span class="nv">json = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nx">@toJSON</span><span class="p">(),</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">4</span>
    <span class="nx">require</span><span class="p">(</span><span class="s">&#39;fs&#39;</span><span class="p">).</span><span class="nx">writeFile</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">file</span><span class="si">}</span><span class="s">.json&quot;</span><span class="p">,</span> <span class="nx">json</span><span class="p">,</span> <span class="s">&quot;utf-8&quot;</span><span class="p">,</span> <span class="nf">(err, data) -&gt;</span>
      <span class="k">throw</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="nx">success</span> <span class="nx">file</span>

<span class="nv">exports.Journal = </span><span class="nx">Journal</span>
<span class="nv">exports.JournalStore = </span><span class="nx">JournalStore</span>
<span class="nv">exports.MemoryJournalStore = </span><span class="nx">MemoryJournalStore</span>

</pre></div>                                   <p><small>This page contains documentation generated automatically on 2016-06-15 from NoFlo's <a href="https://github.com/noflo/noflo/blob/master/src/lib/Journal.coffee">Journal.coffee</a> file.</small></p>         </div>       </div>     </div>   </div> 