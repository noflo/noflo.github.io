---
layout: default
title: "Component API"
categories:
  - api
---
  <div class="row-fluid">
    <div class="page-title documentation-page-title">
      <div class="container">
        <h1 class="page-title__title">API Documentation</h1>
        <a href="https://github.com/noflo/noflo/blob/master/src/lib/Component.coffee" class="btn btn-primary page-title__button big-button">On GitHub</a>
      </div>
    </div>
  </div>

  <div class="row-fluid">
    <div class="container documentation-main-container">
      <div class="main">
        <div class="sidebar span4">
        
          <nav>
            <ul class="sidebar__nav">
              
                
                
                <li>
                  <a {% if page.url == '/api/ArrayPort/index.html' %}class="active" {% endif %}href="/api/ArrayPort/">
                    ArrayPort
                  </a>
                </li>
                
              
                
                
                <li>
                  <a {% if page.url == '/api/AsyncComponent/index.html' %}class="active" {% endif %}href="/api/AsyncComponent/">
                    AsyncComponent
                  </a>
                </li>
                
              
                
                
                <li>
                  <a {% if page.url == '/api/BasePort/index.html' %}class="active" {% endif %}href="/api/BasePort/">
                    BasePort
                  </a>
                </li>
                
              
                
                
                <li>
                  <a {% if page.url == '/api/Component/index.html' %}class="active" {% endif %}href="/api/Component/">
                    Component
                  </a>
                </li>
                
              
                
                
                <li>
                  <a {% if page.url == '/api/ComponentLoader/index.html' %}class="active" {% endif %}href="/api/ComponentLoader/">
                    ComponentLoader
                  </a>
                </li>
                
              
                
                
                <li>
                  <a {% if page.url == '/api/Helpers/index.html' %}class="active" {% endif %}href="/api/Helpers/">
                    Helpers
                  </a>
                </li>
                
              
                
                
                <li>
                  <a {% if page.url == '/api/IP/index.html' %}class="active" {% endif %}href="/api/IP/">
                    IP
                  </a>
                </li>
                
              
                
                
                <li>
                  <a {% if page.url == '/api/InPort/index.html' %}class="active" {% endif %}href="/api/InPort/">
                    InPort
                  </a>
                </li>
                
              
                
                
                <li>
                  <a {% if page.url == '/api/InternalSocket/index.html' %}class="active" {% endif %}href="/api/InternalSocket/">
                    InternalSocket
                  </a>
                </li>
                
              
                
                
                <li>
                  <a {% if page.url == '/api/Network/index.html' %}class="active" {% endif %}href="/api/Network/">
                    Network
                  </a>
                </li>
                
              
                
                
                <li>
                  <a {% if page.url == '/api/NoFlo/index.html' %}class="active" {% endif %}href="/api/NoFlo/">
                    NoFlo
                  </a>
                </li>
                
              
                
                
                <li>
                  <a {% if page.url == '/api/OutPort/index.html' %}class="active" {% endif %}href="/api/OutPort/">
                    OutPort
                  </a>
                </li>
                
              
                
                
                <li>
                  <a {% if page.url == '/api/Platform/index.html' %}class="active" {% endif %}href="/api/Platform/">
                    Platform
                  </a>
                </li>
                
              
                
                
                <li>
                  <a {% if page.url == '/api/Port/index.html' %}class="active" {% endif %}href="/api/Port/">
                    Port
                  </a>
                </li>
                
              
                
                
                <li>
                  <a {% if page.url == '/api/Ports/index.html' %}class="active" {% endif %}href="/api/Ports/">
                    Ports
                  </a>
                </li>
                
              
                
                
                <li>
                  <a {% if page.url == '/api/Streams/index.html' %}class="active" {% endif %}href="/api/Streams/">
                    Streams
                  </a>
                </li>
                
              
                
                
                <li>
                  <a {% if page.url == '/api/Utils/index.html' %}class="active" {% endif %}href="/api/Utils/">
                    Utils
                  </a>
                </li>
                
              
            </ul>
          </nav>
        
        </div>
        <div class="content span8">
          <h1>{{ page.title }}</h1>
          
            
            <pre><code>NoFlo - Flow-Based Programming <span class="hljs-keyword">for</span> JavaScript
(c) <span class="hljs-number">2013</span><span class="hljs-number">-2017</span> Flowhub UG
(c) <span class="hljs-number">2011</span><span class="hljs-number">-2012</span> Henri Bergius, Nemein
NoFlo may be freely distributed under the MIT license
</code></pre><p>Baseclass for regular NoFlo components.</p>

            
              <div class='highlight'><pre>{EventEmitter} = <span class="hljs-built_in">require</span> <span class="hljs-string">'events'</span>

ports = <span class="hljs-built_in">require</span> <span class="hljs-string">'./Ports'</span>
IP = <span class="hljs-built_in">require</span> <span class="hljs-string">'./IP'</span>

debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>) <span class="hljs-string">'noflo:component'</span>
debugBrackets = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>) <span class="hljs-string">'noflo:component:brackets'</span>
debugSend = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>) <span class="hljs-string">'noflo:component:send'</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Component</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">EventEmitter</span></span>
  description: <span class="hljs-string">''</span>
  icon: <span class="hljs-literal">null</span>

  constructor: <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
    options = {} <span class="hljs-keyword">unless</span> options
    options.inPorts = {} <span class="hljs-keyword">unless</span> options.inPorts
    <span class="hljs-keyword">if</span> options.inPorts <span class="hljs-keyword">instanceof</span> ports.InPorts
      @inPorts = options.inPorts
    <span class="hljs-keyword">else</span>
      @inPorts = <span class="hljs-keyword">new</span> ports.InPorts options.inPorts

    options.outPorts = {} <span class="hljs-keyword">unless</span> options.outPorts
    <span class="hljs-keyword">if</span> options.outPorts <span class="hljs-keyword">instanceof</span> ports.OutPorts
      @outPorts = options.outPorts
    <span class="hljs-keyword">else</span>
      @outPorts = <span class="hljs-keyword">new</span> ports.OutPorts options.outPorts

    @icon = options.icon <span class="hljs-keyword">if</span> options.icon
    @description = options.description <span class="hljs-keyword">if</span> options.description

    @started = <span class="hljs-literal">false</span>
    @load = <span class="hljs-number">0</span>
    @ordered = options.ordered ? <span class="hljs-literal">false</span>
    @autoOrdering = options.autoOrdering ? <span class="hljs-literal">null</span>
    @outputQ = []
    @bracketContext =
      in: {}
      out: {}
    @activateOnInput = options.activateOnInput ? <span class="hljs-literal">true</span>
    @forwardBrackets = in: [<span class="hljs-string">'out'</span>, <span class="hljs-string">'error'</span>]

    <span class="hljs-keyword">if</span> <span class="hljs-string">'forwardBrackets'</span> <span class="hljs-keyword">of</span> options
      @forwardBrackets = options.forwardBrackets

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> options.process <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
      @process options.process

  getDescription: <span class="hljs-function">-&gt;</span> @description

  isReady: <span class="hljs-function">-&gt;</span> <span class="hljs-literal">true</span>

  isSubgraph: <span class="hljs-function">-&gt;</span> <span class="hljs-literal">false</span>

  setIcon: <span class="hljs-function"><span class="hljs-params">(@icon)</span> -&gt;</span>
    @emit <span class="hljs-string">'icon'</span>, @icon
  getIcon: <span class="hljs-function">-&gt;</span> @icon

  error: <span class="hljs-function"><span class="hljs-params">(e, groups = [], errorPort = <span class="hljs-string">'error'</span>, scope = <span class="hljs-literal">null</span>)</span> =&gt;</span>
    <span class="hljs-keyword">if</span> @outPorts[errorPort] <span class="hljs-keyword">and</span> (@outPorts[errorPort].isAttached() <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> @outPorts[errorPort].isRequired())
      @outPorts[errorPort].openBracket group, scope: scope <span class="hljs-keyword">for</span> group <span class="hljs-keyword">in</span> groups
      @outPorts[errorPort].data e, scope: scope
      @outPorts[errorPort].closeBracket group, scope: scope <span class="hljs-keyword">for</span> group <span class="hljs-keyword">in</span> groups</pre></div>
            
          
            
            <p>@outPorts[errorPort].disconnect()</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">throw</span> e</pre></div>
            
          
            
            <p>The setUp method is for component-specific initialization. Called
at start-up</p>

            
              <div class='highlight'><pre>  setUp: <span class="hljs-function"><span class="hljs-params">(callback)</span> -&gt;</span>
    <span class="hljs-keyword">do</span> callback</pre></div>
            
          
            
            <p>The tearDown method is for component-specific cleanup. Called
at shutdown</p>

            
              <div class='highlight'><pre>  tearDown: <span class="hljs-function"><span class="hljs-params">(callback)</span> -&gt;</span>
    <span class="hljs-keyword">do</span> callback

  start: <span class="hljs-function"><span class="hljs-params">(callback)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> callback() <span class="hljs-keyword">if</span> @isStarted()
    @setUp (err) =&gt;
      <span class="hljs-keyword">return</span> callback err <span class="hljs-keyword">if</span> err
      @started = <span class="hljs-literal">true</span>
      @emit <span class="hljs-string">'start'</span>
      callback <span class="hljs-literal">null</span>

  shutdown: <span class="hljs-function"><span class="hljs-params">(callback)</span> -&gt;</span>
<span class="hljs-function">    <span class="hljs-title">finalize</span> = =&gt;</span></pre></div>
            
          
            
            <p>Clear contents of inport buffers</p>

            
              <div class='highlight'><pre>      inPorts = @inPorts.ports <span class="hljs-keyword">or</span> @inPorts
      inPort.clear() <span class="hljs-keyword">for</span> inPort <span class="hljs-keyword">in</span> inPorts</pre></div>
            
          
            
            <p>Clear bracket context</p>

            
              <div class='highlight'><pre>      @bracketContext =
        in: {}
        out: {}
      <span class="hljs-keyword">return</span> callback() <span class="hljs-keyword">unless</span> @isStarted()
      @started = <span class="hljs-literal">false</span>
      @emit <span class="hljs-string">'end'</span>
      callback()</pre></div>
            
          
            
            <p>Tell the component that it is time to shut down</p>

            
              <div class='highlight'><pre>    @tearDown (err) =&gt;
      <span class="hljs-keyword">return</span> callback err <span class="hljs-keyword">if</span> err
      <span class="hljs-keyword">if</span> @load &gt; <span class="hljs-number">0</span></pre></div>
            
          
            
            <p>Some in-flight processes, wait for them to finish</p>

            
              <div class='highlight'><pre><span class="hljs-function">        <span class="hljs-title">checkLoad</span> = <span class="hljs-params">(load)</span> -&gt;</span>
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> load &gt; <span class="hljs-number">0</span>
          @removeListener <span class="hljs-string">'deactivate'</span>, checkLoad
          finalize()
        @on <span class="hljs-string">'deactivate'</span>, checkLoad
        <span class="hljs-keyword">return</span>
      finalize()

  isStarted: <span class="hljs-function">-&gt;</span> @started</pre></div>
            
          
            
            <p>Ensures braket forwarding map is correct for the existing ports</p>

            
              <div class='highlight'><pre>  prepareForwarding: <span class="hljs-function">-&gt;</span>
    <span class="hljs-keyword">for</span> inPort, outPorts <span class="hljs-keyword">of</span> @forwardBrackets
      <span class="hljs-keyword">unless</span> inPort <span class="hljs-keyword">of</span> @inPorts.ports
        <span class="hljs-keyword">delete</span> @forwardBrackets[inPort]
        <span class="hljs-keyword">continue</span>
      tmp = []
      <span class="hljs-keyword">for</span> outPort <span class="hljs-keyword">in</span> outPorts
        tmp.push outPort <span class="hljs-keyword">if</span> outPort <span class="hljs-keyword">of</span> @outPorts.ports
      <span class="hljs-keyword">if</span> tmp.length <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>
        <span class="hljs-keyword">delete</span> @forwardBrackets[inPort]
      <span class="hljs-keyword">else</span>
        @forwardBrackets[inPort] = tmp

  isLegacy: <span class="hljs-function">-&gt;</span></pre></div>
            
          
            
            <p>Process API</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">if</span> @handle</pre></div>
            
          
            
            <p>WirePattern</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">if</span> @_wpData</pre></div>
            
          
            
            <p>Legacy</p>

            
              <div class='highlight'><pre>    <span class="hljs-literal">true</span></pre></div>
            
          
            
            <p>Sets process handler function</p>

            
              <div class='highlight'><pre>  process: <span class="hljs-function"><span class="hljs-params">(handle)</span> -&gt;</span>
    <span class="hljs-keyword">unless</span> <span class="hljs-keyword">typeof</span> handle <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Process handler must be a function"</span>
    <span class="hljs-keyword">unless</span> @inPorts
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Component ports must be defined before process function"</span>
    @prepareForwarding()
    @handle = handle
    <span class="hljs-keyword">for</span> name, port <span class="hljs-keyword">of</span> @inPorts.ports
      <span class="hljs-keyword">do</span> (name, port) =&gt;
        port.name = name <span class="hljs-keyword">unless</span> port.name
        port.<span class="hljs-literal">on</span> <span class="hljs-string">'ip'</span>, <span class="hljs-function"><span class="hljs-params">(ip)</span> =&gt;</span>
          @handleIP ip, port
    @

  isForwardingInport: <span class="hljs-function"><span class="hljs-params">(port)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> port <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span>
      portName = port
    <span class="hljs-keyword">else</span>
      portName = port.name
    <span class="hljs-keyword">if</span> portName <span class="hljs-keyword">of</span> @forwardBrackets
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    <span class="hljs-literal">false</span>

  isForwardingOutport: <span class="hljs-function"><span class="hljs-params">(inport, outport)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> inport <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span>
      inportName = inport
    <span class="hljs-keyword">else</span>
      inportName = inport.name
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> outport <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span>
      outportName = outport
    <span class="hljs-keyword">else</span>
      outportName = outport.name
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">unless</span> @forwardBrackets[inportName]
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">if</span> @forwardBrackets[inportName].indexOf(outportName) <span class="hljs-keyword">isnt</span> <span class="hljs-number">-1</span>
    <span class="hljs-literal">false</span>

  isOrdered: <span class="hljs-function">-&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">if</span> @ordered
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">if</span> @autoOrdering
    <span class="hljs-literal">false</span></pre></div>
            
          
            
            <p>The component has received an Information Packet. Call the processing function
so that firing pattern preconditions can be checked and component can do
processing as needed.</p>

            
              <div class='highlight'><pre>  handleIP: <span class="hljs-function"><span class="hljs-params">(ip, port)</span> -&gt;</span>
    <span class="hljs-keyword">unless</span> port.options.triggering</pre></div>
            
          
            
            <p>If port is non-triggering, we can skip the process function call</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">if</span> ip.type <span class="hljs-keyword">is</span> <span class="hljs-string">'openBracket'</span> <span class="hljs-keyword">and</span> @autoOrdering <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> @ordered</pre></div>
            
          
            
            <p>Switch component to ordered mode when receiving a stream unless
auto-ordering is disabled</p>

            
              <div class='highlight'><pre>      debug <span class="hljs-string">"<span class="hljs-subst">#{@nodeId}</span> port '<span class="hljs-subst">#{port.name}</span>' entered auto-ordering mode"</span>
      @autoOrdering = <span class="hljs-literal">true</span></pre></div>
            
          
            
            <p>Initialize the result object for situations where output needs
to be queued to be kept in order</p>

            
              <div class='highlight'><pre>    result = {}

    <span class="hljs-keyword">if</span> @isForwardingInport port</pre></div>
            
          
            
            <p>For bracket-forwarding inports we need to initialize a bracket context
so that brackets can be sent as part of the output, and closed after.</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">if</span> ip.type <span class="hljs-keyword">is</span> <span class="hljs-string">'openBracket'</span></pre></div>
            
          
            
            <p>For forwarding ports openBrackets don’t fire</p>

            
              <div class='highlight'><pre>        <span class="hljs-keyword">return</span>

      <span class="hljs-keyword">if</span> ip.type <span class="hljs-keyword">is</span> <span class="hljs-string">'closeBracket'</span></pre></div>
            
          
            
            <p>For forwarding ports closeBrackets don’t fire
However, we need to handle several different scenarios:
A. There are closeBrackets in queue before current packet
B. There are closeBrackets in queue after current packet
C. We’ve queued the results from all in-flight processes and
   new closeBracket arrives</p>

            
              <div class='highlight'><pre>        buf = port.getBuffer ip.scope, ip.index
        dataPackets = buf.filter (ip) -&gt; ip.type <span class="hljs-keyword">is</span> <span class="hljs-string">'data'</span>
        <span class="hljs-keyword">if</span> @outputQ.length &gt;= @load <span class="hljs-keyword">and</span> dataPackets.length <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> buf[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> ip</pre></div>
            
          
            
            <p>Remove from buffer</p>

            
              <div class='highlight'><pre>          port.get ip.scope, ip.index
          context = @getBracketContext(<span class="hljs-string">'in'</span>, port.name, ip.scope, ip.index).pop()
          context.closeIp = ip
          debugBrackets <span class="hljs-string">"<span class="hljs-subst">#{@nodeId}</span> closeBracket-C from '<span class="hljs-subst">#{context.source}</span>' to <span class="hljs-subst">#{context.ports}</span>: '<span class="hljs-subst">#{ip.data}</span>'"</span>
          result =
            __resolved: <span class="hljs-literal">true</span>
            __bracketClosingAfter: [context]
          @outputQ.push result
          <span class="hljs-keyword">do</span> @processOutputQueue</pre></div>
            
          
            
            <p>Check if buffer contains data IPs. If it does, we want to allow
firing</p>

            
              <div class='highlight'><pre>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> dataPackets.length</pre></div>
            
          
            
            <p>Prepare the input/output pair</p>

            
              <div class='highlight'><pre>    context = <span class="hljs-keyword">new</span> ProcessContext ip, @, port, result
    input = <span class="hljs-keyword">new</span> ProcessInput @inPorts, context
    output = <span class="hljs-keyword">new</span> ProcessOutput @outPorts, context
    <span class="hljs-keyword">try</span></pre></div>
            
          
            
            <p>Call the processing function</p>

            
              <div class='highlight'><pre>      @handle input, output, context
    <span class="hljs-keyword">catch</span> e
      @deactivate context
      output.sendDone e

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> context.activated
    <span class="hljs-keyword">if</span> port.isAddressable()
      debug <span class="hljs-string">"<span class="hljs-subst">#{@nodeId}</span> packet on '<span class="hljs-subst">#{port.name}</span>[<span class="hljs-subst">#{ip.index}</span>]' didn't match preconditions: <span class="hljs-subst">#{ip.type}</span>"</span>
      <span class="hljs-keyword">return</span>
    debug <span class="hljs-string">"<span class="hljs-subst">#{@nodeId}</span> packet on '<span class="hljs-subst">#{port.name}</span>' didn't match preconditions: <span class="hljs-subst">#{ip.type}</span>"</span>
    <span class="hljs-keyword">return</span>

  getBracketContext: <span class="hljs-function"><span class="hljs-params">(type, port, scope, idx)</span> -&gt;</span>
    {name, index} = ports.normalizePortName port
    index = idx <span class="hljs-keyword">if</span> idx?
    portsList = <span class="hljs-keyword">if</span> type <span class="hljs-keyword">is</span> <span class="hljs-string">'in'</span> <span class="hljs-keyword">then</span> @inPorts <span class="hljs-keyword">else</span> @outPorts
    <span class="hljs-keyword">if</span> portsList[name].isAddressable()
      port = <span class="hljs-string">"<span class="hljs-subst">#{name}</span>[<span class="hljs-subst">#{index}</span>]"</span></pre></div>
            
          
            
            <p>Ensure we have a bracket context for the current scope</p>

            
              <div class='highlight'><pre>    @bracketContext[type][port] = {} <span class="hljs-keyword">unless</span> @bracketContext[type][port]
    @bracketContext[type][port][scope] = [] <span class="hljs-keyword">unless</span> @bracketContext[type][port][scope]
    <span class="hljs-keyword">return</span> @bracketContext[type][port][scope]

  addToResult: <span class="hljs-function"><span class="hljs-params">(result, port, ip, before = <span class="hljs-literal">false</span>)</span> -&gt;</span>
    {name, index} = ports.normalizePortName port
    method = <span class="hljs-keyword">if</span> before <span class="hljs-keyword">then</span> <span class="hljs-string">'unshift'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'push'</span>
    <span class="hljs-keyword">if</span> @outPorts[name].isAddressable()
      idx = <span class="hljs-keyword">if</span> index <span class="hljs-keyword">then</span> parseInt(index) <span class="hljs-keyword">else</span> ip.index
      result[name] = {} <span class="hljs-keyword">unless</span> result[name]
      result[name][idx] = [] <span class="hljs-keyword">unless</span> result[name][idx]
      ip.index = idx
      result[name][idx][method] ip
      <span class="hljs-keyword">return</span>
    result[name] = [] <span class="hljs-keyword">unless</span> result[name]
    result[name][method] ip

  getForwardableContexts: <span class="hljs-function"><span class="hljs-params">(inport, outport, contexts)</span> -&gt;</span>
    {name, index} = ports.normalizePortName outport
    forwardable = []
    contexts.forEach (ctx, idx) =&gt;</pre></div>
            
          
            
            <p>No forwarding to this outport</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> @isForwardingOutport inport, name</pre></div>
            
          
            
            <p>We have already forwarded this context to this outport</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> ctx.ports.indexOf(outport) <span class="hljs-keyword">is</span> <span class="hljs-number">-1</span></pre></div>
            
          
            
            <p>See if we have already forwarded the same bracket from another
inport</p>

            
              <div class='highlight'><pre>      outContext = @getBracketContext(<span class="hljs-string">'out'</span>, name, ctx.ip.scope, index)[idx]
      <span class="hljs-keyword">if</span> outContext
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> outContext.ip.data <span class="hljs-keyword">is</span> ctx.ip.data <span class="hljs-keyword">and</span> outContext.ports.indexOf(outport) <span class="hljs-keyword">isnt</span> <span class="hljs-number">-1</span>
      forwardable.push ctx
    <span class="hljs-keyword">return</span> forwardable

  addBracketForwards: <span class="hljs-function"><span class="hljs-params">(result)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> result.__bracketClosingBefore?.length
      <span class="hljs-keyword">for</span> context <span class="hljs-keyword">in</span> result.__bracketClosingBefore
        debugBrackets <span class="hljs-string">"<span class="hljs-subst">#{@nodeId}</span> closeBracket-A from '<span class="hljs-subst">#{context.source}</span>' to <span class="hljs-subst">#{context.ports}</span>: '<span class="hljs-subst">#{context.closeIp.data}</span>'"</span>
        <span class="hljs-keyword">continue</span> <span class="hljs-keyword">unless</span> context.ports.length
        <span class="hljs-keyword">for</span> port <span class="hljs-keyword">in</span> context.ports
          ipClone = context.closeIp.clone()
          @addToResult result, port, ipClone, <span class="hljs-literal">true</span>
          @getBracketContext(<span class="hljs-string">'out'</span>, port, ipClone.scope).pop()

    <span class="hljs-keyword">if</span> result.__bracketContext</pre></div>
            
          
            
            <p>First see if there are any brackets to forward. We need to reverse
the keys so that they get added in correct order</p>

            
              <div class='highlight'><pre>      Object.keys(result.__bracketContext).reverse().forEach (inport) =&gt;
        context = result.__bracketContext[inport]
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> context.length
        <span class="hljs-keyword">for</span> outport, ips <span class="hljs-keyword">of</span> result
          <span class="hljs-keyword">continue</span> <span class="hljs-keyword">if</span> outport.indexOf(<span class="hljs-string">'__'</span>) <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>
          <span class="hljs-keyword">if</span> @outPorts[outport].isAddressable()
            <span class="hljs-keyword">for</span> idx, idxIps <span class="hljs-keyword">of</span> ips</pre></div>
            
          
            
            <p>Don’t register indexes we’re only sending brackets to</p>

            
              <div class='highlight'><pre>              datas = idxIps.filter (ip) -&gt; ip.type <span class="hljs-keyword">is</span> <span class="hljs-string">'data'</span>
              <span class="hljs-keyword">continue</span> <span class="hljs-keyword">unless</span> datas.length
              portIdentifier = <span class="hljs-string">"<span class="hljs-subst">#{outport}</span>[<span class="hljs-subst">#{idx}</span>]"</span>
              unforwarded = @getForwardableContexts inport, portIdentifier, context
              <span class="hljs-keyword">continue</span> <span class="hljs-keyword">unless</span> unforwarded.length
              forwardedOpens = []
              <span class="hljs-keyword">for</span> ctx <span class="hljs-keyword">in</span> unforwarded
                debugBrackets <span class="hljs-string">"<span class="hljs-subst">#{@nodeId}</span> openBracket from '<span class="hljs-subst">#{inport}</span>' to '<span class="hljs-subst">#{portIdentifier}</span>': '<span class="hljs-subst">#{ctx.ip.data}</span>'"</span>
                ipClone = ctx.ip.clone()
                ipClone.index = parseInt idx
                forwardedOpens.push ipClone
                ctx.ports.push portIdentifier
                @getBracketContext(<span class="hljs-string">'out'</span>, outport, ctx.ip.scope, idx).push ctx
              forwardedOpens.reverse()
              @addToResult result, outport, ip, <span class="hljs-literal">true</span> <span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> forwardedOpens
            <span class="hljs-keyword">continue</span></pre></div>
            
          
            
            <p>Don’t register ports we’re only sending brackets to</p>

            
              <div class='highlight'><pre>          datas = ips.filter (ip) -&gt; ip.type <span class="hljs-keyword">is</span> <span class="hljs-string">'data'</span>
          <span class="hljs-keyword">continue</span> <span class="hljs-keyword">unless</span> datas.length
          unforwarded = @getForwardableContexts inport, outport, context
          <span class="hljs-keyword">continue</span> <span class="hljs-keyword">unless</span> unforwarded.length
          forwardedOpens = []
          <span class="hljs-keyword">for</span> ctx <span class="hljs-keyword">in</span> unforwarded
            debugBrackets <span class="hljs-string">"<span class="hljs-subst">#{@nodeId}</span> openBracket from '<span class="hljs-subst">#{inport}</span>' to '<span class="hljs-subst">#{outport}</span>': '<span class="hljs-subst">#{ctx.ip.data}</span>'"</span>
            forwardedOpens.push ctx.ip.clone()
            ctx.ports.push outport
            @getBracketContext(<span class="hljs-string">'out'</span>, outport, ctx.ip.scope).push ctx
          forwardedOpens.reverse()
          @addToResult result, outport, ip, <span class="hljs-literal">true</span> <span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> forwardedOpens

    <span class="hljs-keyword">if</span> result.__bracketClosingAfter?.length
      <span class="hljs-keyword">for</span> context <span class="hljs-keyword">in</span> result.__bracketClosingAfter
        debugBrackets <span class="hljs-string">"<span class="hljs-subst">#{@nodeId}</span> closeBracket-B from '<span class="hljs-subst">#{context.source}</span>' to <span class="hljs-subst">#{context.ports}</span>: '<span class="hljs-subst">#{context.closeIp.data}</span>'"</span>
        <span class="hljs-keyword">continue</span> <span class="hljs-keyword">unless</span> context.ports.length
        <span class="hljs-keyword">for</span> port <span class="hljs-keyword">in</span> context.ports
          ipClone = context.closeIp.clone()
          @addToResult result, port, ipClone, <span class="hljs-literal">false</span>
          @getBracketContext(<span class="hljs-string">'out'</span>, port, ipClone.scope).pop()

    <span class="hljs-keyword">delete</span> result.__bracketClosingBefore
    <span class="hljs-keyword">delete</span> result.__bracketContext
    <span class="hljs-keyword">delete</span> result.__bracketClosingAfter

  processOutputQueue: <span class="hljs-function">-&gt;</span>
    <span class="hljs-keyword">while</span> @outputQ.length &gt; <span class="hljs-number">0</span>
      result = @outputQ[<span class="hljs-number">0</span>]
      <span class="hljs-keyword">break</span> <span class="hljs-keyword">unless</span> result.__resolved
      @addBracketForwards result
      <span class="hljs-keyword">for</span> port, ips <span class="hljs-keyword">of</span> result
        <span class="hljs-keyword">continue</span> <span class="hljs-keyword">if</span> port.indexOf(<span class="hljs-string">'__'</span>) <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>
        <span class="hljs-keyword">if</span> @outPorts.ports[port].isAddressable()
          <span class="hljs-keyword">for</span> idx, idxIps <span class="hljs-keyword">of</span> ips
            idx = parseInt idx
            <span class="hljs-keyword">continue</span> <span class="hljs-keyword">unless</span> @outPorts.ports[port].isAttached idx
            <span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> idxIps
              portIdentifier = <span class="hljs-string">"<span class="hljs-subst">#{port}</span>[<span class="hljs-subst">#{ip.index}</span>]"</span>
              <span class="hljs-keyword">if</span> ip.type <span class="hljs-keyword">is</span> <span class="hljs-string">'openBracket'</span>
                debugSend <span class="hljs-string">"<span class="hljs-subst">#{@nodeId}</span> sending <span class="hljs-subst">#{portIdentifier}</span> &lt; '<span class="hljs-subst">#{ip.data}</span>'"</span>
              <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ip.type <span class="hljs-keyword">is</span> <span class="hljs-string">'closeBracket'</span>
                debugSend <span class="hljs-string">"<span class="hljs-subst">#{@nodeId}</span> sending <span class="hljs-subst">#{portIdentifier}</span> &gt; '<span class="hljs-subst">#{ip.data}</span>'"</span>
              <span class="hljs-keyword">else</span>
                debugSend <span class="hljs-string">"<span class="hljs-subst">#{@nodeId}</span> sending <span class="hljs-subst">#{portIdentifier}</span> DATA"</span>
              @outPorts[port].sendIP ip
          <span class="hljs-keyword">continue</span>
        <span class="hljs-keyword">continue</span> <span class="hljs-keyword">unless</span> @outPorts.ports[port].isAttached()
        <span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> ips
          portIdentifier = port
          <span class="hljs-keyword">if</span> ip.type <span class="hljs-keyword">is</span> <span class="hljs-string">'openBracket'</span>
            debugSend <span class="hljs-string">"<span class="hljs-subst">#{@nodeId}</span> sending <span class="hljs-subst">#{portIdentifier}</span> &lt; '<span class="hljs-subst">#{ip.data}</span>'"</span>
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ip.type <span class="hljs-keyword">is</span> <span class="hljs-string">'closeBracket'</span>
            debugSend <span class="hljs-string">"<span class="hljs-subst">#{@nodeId}</span> sending <span class="hljs-subst">#{portIdentifier}</span> &gt; '<span class="hljs-subst">#{ip.data}</span>'"</span>
          <span class="hljs-keyword">else</span>
            debugSend <span class="hljs-string">"<span class="hljs-subst">#{@nodeId}</span> sending <span class="hljs-subst">#{portIdentifier}</span> DATA"</span>
          @outPorts[port].sendIP ip
      @outputQ.shift()

  activate: <span class="hljs-function"><span class="hljs-params">(context)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> context.activated <span class="hljs-comment"># prevent double activation</span>
    context.activated = <span class="hljs-literal">true</span>
    context.deactivated = <span class="hljs-literal">false</span>
    @load++
    @emit <span class="hljs-string">'activate'</span>, @load
    <span class="hljs-keyword">if</span> @ordered <span class="hljs-keyword">or</span> @autoOrdering
      @outputQ.push context.result

  deactivate: <span class="hljs-function"><span class="hljs-params">(context)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> context.deactivated <span class="hljs-comment"># prevent double deactivation</span>
    context.deactivated = <span class="hljs-literal">true</span>
    context.activated = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">if</span> @isOrdered()
      @processOutputQueue()
    @load--
    @emit <span class="hljs-string">'deactivate'</span>, @load

exports.Component = Component

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProcessContext</span></span>
  constructor: <span class="hljs-function"><span class="hljs-params">(@ip, @nodeInstance, @port, @result)</span> -&gt;</span>
    @scope = @ip.scope
    @activated = <span class="hljs-literal">false</span>
    @deactivated = <span class="hljs-literal">false</span>
  activate: <span class="hljs-function">-&gt;</span></pre></div>
            
          
            
            <p>Push a new result value if previous has been sent already</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">if</span> @result.__resolved <span class="hljs-keyword">or</span> @nodeInstance.outputQ.indexOf(@result) <span class="hljs-keyword">is</span> <span class="hljs-number">-1</span>
      @result = {}
    @nodeInstance.activate @
  deactivate: <span class="hljs-function">-&gt;</span>
    @result.__resolved = <span class="hljs-literal">true</span> <span class="hljs-keyword">unless</span> @result.__resolved
    @nodeInstance.deactivate @

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProcessInput</span></span>
  constructor: <span class="hljs-function"><span class="hljs-params">(@ports, @context)</span> -&gt;</span>
    @nodeInstance = @context.nodeInstance
    @ip = @context.ip
    @port = @context.port
    @result = @context.result
    @scope = @context.scope</pre></div>
            
          
            
            <p>When preconditions are met, set component state to <code>activated</code></p>

            
              <div class='highlight'><pre>  activate: <span class="hljs-function">-&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> @context.activated
    <span class="hljs-keyword">if</span> @nodeInstance.isOrdered()</pre></div>
            
          
            
            <p>We’re handling packets in order. Set the result as non-resolved
so that it can be send when the order comes up</p>

            
              <div class='highlight'><pre>      @result.__resolved = <span class="hljs-literal">false</span>
    @nodeInstance.activate @context
    <span class="hljs-keyword">if</span> @port.isAddressable()
      debug <span class="hljs-string">"<span class="hljs-subst">#{@nodeInstance.nodeId}</span> packet on '<span class="hljs-subst">#{@port.name}</span>[<span class="hljs-subst">#{@ip.index}</span>]' caused activation <span class="hljs-subst">#{@nodeInstance.load}</span>: <span class="hljs-subst">#{@ip.type}</span>"</span>
    <span class="hljs-keyword">else</span>
      debug <span class="hljs-string">"<span class="hljs-subst">#{@nodeInstance.nodeId}</span> packet on '<span class="hljs-subst">#{@port.name}</span>' caused activation <span class="hljs-subst">#{@nodeInstance.load}</span>: <span class="hljs-subst">#{@ip.type}</span>"</span></pre></div>
            
          
            
            <h2 id="connection-listing">Connection listing</h2>
<p>This allows components to check which input ports are attached. This is
useful mainly for addressable ports</p>

            
              <div class='highlight'><pre>  attached: <span class="hljs-function"><span class="hljs-params">(args...)</span> -&gt;</span>
    args = [<span class="hljs-string">'in'</span>] <span class="hljs-keyword">unless</span> args.length
    res = []
    <span class="hljs-keyword">for</span> port <span class="hljs-keyword">in</span> args
      res.push @ports[port].listAttached()
    <span class="hljs-keyword">return</span> res.pop() <span class="hljs-keyword">if</span> args.length <span class="hljs-keyword">is</span> <span class="hljs-number">1</span>
    res</pre></div>
            
          
            
            <h2 id="input-preconditions">Input preconditions</h2>
<p>When the processing function is called, it can check if input buffers
contain the packets needed for the process to fire.
This precondition handling is done via the <code>has</code> and <code>hasStream</code> methods.</p>

            
          
            
            <p>Returns true if a port (or ports joined by logical AND) has a new IP
Passing a validation callback as a last argument allows more selective
checking of packets.</p>

            
              <div class='highlight'><pre>  has: <span class="hljs-function"><span class="hljs-params">(args...)</span> -&gt;</span>
    args = [<span class="hljs-string">'in'</span>] <span class="hljs-keyword">unless</span> args.length
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
      validate = args.pop()
    <span class="hljs-keyword">else</span>
<span class="hljs-function">      <span class="hljs-title">validate</span> = -&gt;</span> <span class="hljs-literal">true</span>
    <span class="hljs-keyword">for</span> port <span class="hljs-keyword">in</span> args
      <span class="hljs-keyword">if</span> Array.isArray port
        <span class="hljs-keyword">unless</span> @ports[port[<span class="hljs-number">0</span>]].isAddressable()
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Non-addressable ports, access must be with string <span class="hljs-subst">#{port[<span class="hljs-number">0</span>]}</span>"</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">unless</span> @ports[port[<span class="hljs-number">0</span>]].has @scope, port[<span class="hljs-number">1</span>], validate
        <span class="hljs-keyword">continue</span>
      <span class="hljs-keyword">if</span> @ports[port].isAddressable()
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"For addressable ports, access must be with array [<span class="hljs-subst">#{port}</span>, idx]"</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">unless</span> @ports[port].has @scope, validate
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span></pre></div>
            
          
            
            <p>Returns true if the ports contain data packets</p>

            
              <div class='highlight'><pre>  hasData: <span class="hljs-function"><span class="hljs-params">(args...)</span> -&gt;</span>
    args = [<span class="hljs-string">'in'</span>] <span class="hljs-keyword">unless</span> args.length
    args.push (ip) -&gt; ip.type <span class="hljs-keyword">is</span> <span class="hljs-string">'data'</span>
    <span class="hljs-keyword">return</span> @has.apply @, args</pre></div>
            
          
            
            <p>Returns true if a port has a complete stream in its input buffer.</p>

            
              <div class='highlight'><pre>  hasStream: <span class="hljs-function"><span class="hljs-params">(args...)</span> -&gt;</span>
    args = [<span class="hljs-string">'in'</span>] <span class="hljs-keyword">unless</span> args.length

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> args[args.length - <span class="hljs-number">1</span>] <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
      validateStream = args.pop()
    <span class="hljs-keyword">else</span>
<span class="hljs-function">      <span class="hljs-title">validateStream</span> = -&gt;</span> <span class="hljs-literal">true</span>

    <span class="hljs-keyword">for</span> port <span class="hljs-keyword">in</span> args
      portBrackets = []
      dataBrackets = []
      hasData = <span class="hljs-literal">false</span>
<span class="hljs-function">      <span class="hljs-title">validate</span> = <span class="hljs-params">(ip)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> ip.type <span class="hljs-keyword">is</span> <span class="hljs-string">'openBracket'</span>
          portBrackets.push ip.data
          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        <span class="hljs-keyword">if</span> ip.type <span class="hljs-keyword">is</span> <span class="hljs-string">'data'</span></pre></div>
            
          
            
            <p>Run the stream validation callback</p>

            
              <div class='highlight'><pre>          hasData = validateStream ip, portBrackets</pre></div>
            
          
            
            <p>Data IP on its own is a valid stream</p>

            
              <div class='highlight'><pre>          <span class="hljs-keyword">return</span> hasData <span class="hljs-keyword">unless</span> portBrackets.length</pre></div>
            
          
            
            <p>Otherwise we need to check for complete stream</p>

            
              <div class='highlight'><pre>          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        <span class="hljs-keyword">if</span> ip.type <span class="hljs-keyword">is</span> <span class="hljs-string">'closeBracket'</span>
          portBrackets.pop()
          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">if</span> portBrackets.length
          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">unless</span> hasData
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">unless</span> @has port, validate
    <span class="hljs-literal">true</span></pre></div>
            
          
            
            <h2 id="input-processing">Input processing</h2>
<p>Once preconditions have been met, the processing function can read from
the input buffers. Reading packets sets the component as “activated”.</p>
<p>Fetches IP object(s) for port(s)</p>

            
              <div class='highlight'><pre>  get: <span class="hljs-function"><span class="hljs-params">(args...)</span> -&gt;</span>
    @activate()
    args = [<span class="hljs-string">'in'</span>] <span class="hljs-keyword">unless</span> args.length
    res = []
    <span class="hljs-keyword">for</span> port <span class="hljs-keyword">in</span> args
      <span class="hljs-keyword">if</span> Array.isArray port
        [portname, idx] = port
        <span class="hljs-keyword">unless</span> @ports[portname].isAddressable()
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">'Non-addressable ports, access must be with string portname'</span>
      <span class="hljs-keyword">else</span>
        portname = port
        <span class="hljs-keyword">if</span> @ports[portname].isAddressable()
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">'For addressable ports, access must be with array [portname, idx]'</span>
      <span class="hljs-keyword">if</span> @nodeInstance.isForwardingInport portname
        ip = @__getForForwarding portname, idx
        res.push ip
        <span class="hljs-keyword">continue</span>
      ip = @ports[portname].get @scope, idx
      res.push ip

    <span class="hljs-keyword">if</span> args.length <span class="hljs-keyword">is</span> <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> res[<span class="hljs-number">0</span>] <span class="hljs-keyword">else</span> res

  __getForForwarding: <span class="hljs-function"><span class="hljs-params">(port, idx)</span> -&gt;</span>
    prefix = []
    dataIp = <span class="hljs-literal">null</span></pre></div>
            
          
            
            <p>Read IPs until we hit data</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">loop</span></pre></div>
            
          
            
            <p>Read next packet</p>

            
              <div class='highlight'><pre>      ip = @ports[port].get @scope, idx</pre></div>
            
          
            
            <p>Stop at the end of the buffer</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">break</span> <span class="hljs-keyword">unless</span> ip
      <span class="hljs-keyword">if</span> ip.type <span class="hljs-keyword">is</span> <span class="hljs-string">'data'</span></pre></div>
            
          
            
            <p>Hit the data IP, stop here</p>

            
              <div class='highlight'><pre>        dataIp = ip
        <span class="hljs-keyword">break</span></pre></div>
            
          
            
            <p>Keep track of bracket closings and openings before</p>

            
              <div class='highlight'><pre>      prefix.push ip</pre></div>
            
          
            
            <p>Forwarding brackets that came before data packet need to manipulate context
and be added to result so they can be forwarded correctly to ports that
need them</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> prefix
      <span class="hljs-keyword">if</span> ip.type <span class="hljs-keyword">is</span> <span class="hljs-string">'closeBracket'</span></pre></div>
            
          
            
            <p>Bracket closings before data should remove bracket context</p>

            
              <div class='highlight'><pre>        @result.__bracketClosingBefore = [] <span class="hljs-keyword">unless</span> @result.__bracketClosingBefore
        context = @nodeInstance.getBracketContext(<span class="hljs-string">'in'</span>, port, @scope, idx).pop()
        context.closeIp = ip
        @result.__bracketClosingBefore.push context
        <span class="hljs-keyword">continue</span>
      <span class="hljs-keyword">if</span> ip.type <span class="hljs-keyword">is</span> <span class="hljs-string">'openBracket'</span></pre></div>
            
          
            
            <p>Bracket openings need to go to bracket context</p>

            
              <div class='highlight'><pre>        @nodeInstance.getBracketContext(<span class="hljs-string">'in'</span>, port, @scope, idx).push
          ip: ip
          ports: []
          source: port
        <span class="hljs-keyword">continue</span></pre></div>
            
          
            
            <p>Add current bracket context to the result so that when we send
to ports we can also add the surrounding brackets</p>

            
              <div class='highlight'><pre>    @result.__bracketContext = {} <span class="hljs-keyword">unless</span> @result.__bracketContext
    @result.__bracketContext[port] = @nodeInstance.getBracketContext(<span class="hljs-string">'in'</span>, port, @scope, idx).slice <span class="hljs-number">0</span></pre></div>
            
          
            
            <p>Bracket closings that were in buffer after the data packet need to
be added to result for done() to read them from</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">return</span> dataIp</pre></div>
            
          
            
            <p>Fetches <code>data</code> property of IP object(s) for given port(s)</p>

            
              <div class='highlight'><pre>  getData: <span class="hljs-function"><span class="hljs-params">(args...)</span> -&gt;</span>
    args = [<span class="hljs-string">'in'</span>] <span class="hljs-keyword">unless</span> args.length

    datas = []
    <span class="hljs-keyword">for</span> port <span class="hljs-keyword">in</span> args
      packet = @get port
      <span class="hljs-keyword">unless</span> packet?</pre></div>
            
          
            
            <p>we add the null packet to the array so when getting
multiple ports, if one is null we still return it
so the indexes are correct.</p>

            
              <div class='highlight'><pre>        datas.push packet
        <span class="hljs-keyword">continue</span>

      <span class="hljs-keyword">until</span> packet.type <span class="hljs-keyword">is</span> <span class="hljs-string">'data'</span>
        packet = @get port
        <span class="hljs-keyword">break</span> <span class="hljs-keyword">unless</span> packet

      datas.push packet.data

    <span class="hljs-keyword">return</span> datas.pop() <span class="hljs-keyword">if</span> args.length <span class="hljs-keyword">is</span> <span class="hljs-number">1</span>
    datas</pre></div>
            
          
            
            <p>Fetches a complete data stream from the buffer.</p>

            
              <div class='highlight'><pre>  getStream: <span class="hljs-function"><span class="hljs-params">(args...)</span> -&gt;</span>
    args = [<span class="hljs-string">'in'</span>] <span class="hljs-keyword">unless</span> args.length
    datas = []
    <span class="hljs-keyword">for</span> port <span class="hljs-keyword">in</span> args
      portBrackets = []
      portPackets = []
      hasData = <span class="hljs-literal">false</span>
      ip = @get port
      datas.push <span class="hljs-literal">undefined</span> <span class="hljs-keyword">unless</span> ip
      <span class="hljs-keyword">while</span> ip
        <span class="hljs-keyword">if</span> ip.type <span class="hljs-keyword">is</span> <span class="hljs-string">'openBracket'</span>
          <span class="hljs-keyword">unless</span> portBrackets.length</pre></div>
            
          
            
            <p>First openBracket in stream, drop previous</p>

            
              <div class='highlight'><pre>            portPackets = []
            hasData = <span class="hljs-literal">false</span>
          portBrackets.push ip.data
          portPackets.push ip
        <span class="hljs-keyword">if</span> ip.type <span class="hljs-keyword">is</span> <span class="hljs-string">'data'</span>
          portPackets.push ip
          hasData = <span class="hljs-literal">true</span></pre></div>
            
          
            
            <p>Unbracketed data packet is a valid stream</p>

            
              <div class='highlight'><pre>          <span class="hljs-keyword">break</span> <span class="hljs-keyword">unless</span> portBrackets.length
        <span class="hljs-keyword">if</span> ip.type <span class="hljs-keyword">is</span> <span class="hljs-string">'closeBracket'</span>
          portPackets.push ip
          portBrackets.pop()
          <span class="hljs-keyword">if</span> hasData <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> portBrackets.length</pre></div>
            
          
            
            <p>Last close bracket finishes stream if there was data inside</p>

            
              <div class='highlight'><pre>            <span class="hljs-keyword">break</span>
        ip = @get port
      datas.push portPackets

    <span class="hljs-keyword">return</span> datas.pop() <span class="hljs-keyword">if</span> args.length <span class="hljs-keyword">is</span> <span class="hljs-number">1</span>
    datas

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProcessOutput</span></span>
  constructor: <span class="hljs-function"><span class="hljs-params">(@ports, @context)</span> -&gt;</span>
    @nodeInstance = @context.nodeInstance
    @ip = @context.ip
    @result = @context.result
    @scope = @context.scope</pre></div>
            
          
            
            <p>Checks if a value is an Error</p>

            
              <div class='highlight'><pre>  isError: <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
    err <span class="hljs-keyword">instanceof</span> Error <span class="hljs-keyword">or</span>
    Array.isArray(err) <span class="hljs-keyword">and</span> err.length &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> err[<span class="hljs-number">0</span>] <span class="hljs-keyword">instanceof</span> Error</pre></div>
            
          
            
            <p>Sends an error object</p>

            
              <div class='highlight'><pre>  error: <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
    multiple = Array.isArray err
    err = [err] <span class="hljs-keyword">unless</span> multiple
    <span class="hljs-keyword">if</span> <span class="hljs-string">'error'</span> <span class="hljs-keyword">of</span> @ports <span class="hljs-keyword">and</span>
    (@ports.error.isAttached() <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> @ports.error.isRequired())
      @sendIP <span class="hljs-string">'error'</span>, <span class="hljs-keyword">new</span> IP <span class="hljs-string">'openBracket'</span> <span class="hljs-keyword">if</span> multiple
      @sendIP <span class="hljs-string">'error'</span>, e <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> err
      @sendIP <span class="hljs-string">'error'</span>, <span class="hljs-keyword">new</span> IP <span class="hljs-string">'closeBracket'</span> <span class="hljs-keyword">if</span> multiple
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">throw</span> e <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> err</pre></div>
            
          
            
            <p>Sends a single IP object to a port</p>

            
              <div class='highlight'><pre>  sendIP: <span class="hljs-function"><span class="hljs-params">(port, packet)</span> -&gt;</span>
    <span class="hljs-keyword">unless</span> IP.isIP packet
      ip = <span class="hljs-keyword">new</span> IP <span class="hljs-string">'data'</span>, packet
    <span class="hljs-keyword">else</span>
      ip = packet
    ip.scope = @scope <span class="hljs-keyword">if</span> @scope <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">and</span> ip.scope <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>

    <span class="hljs-keyword">if</span> @nodeInstance.outPorts[port].isAddressable() <span class="hljs-keyword">and</span> ip.index <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">'Sending packets to addressable ports requires specifying index'</span>

    <span class="hljs-keyword">if</span> @nodeInstance.isOrdered()
      @nodeInstance.addToResult @result, port, ip
      <span class="hljs-keyword">return</span>
    @nodeInstance.outPorts[port].sendIP ip</pre></div>
            
          
            
            <p>Sends packets for each port as a key in the map
or sends Error or a list of Errors if passed such</p>

            
              <div class='highlight'><pre>  send: <span class="hljs-function"><span class="hljs-params">(outputMap)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> @error outputMap <span class="hljs-keyword">if</span> @isError outputMap

    componentPorts = []
    mapIsInPorts = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">for</span> port <span class="hljs-keyword">in</span> Object.keys @ports.ports
      componentPorts.push port <span class="hljs-keyword">if</span> port <span class="hljs-keyword">isnt</span> <span class="hljs-string">'error'</span> <span class="hljs-keyword">and</span> port <span class="hljs-keyword">isnt</span> <span class="hljs-string">'ports'</span> <span class="hljs-keyword">and</span> port <span class="hljs-keyword">isnt</span> <span class="hljs-string">'_callbacks'</span>
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> mapIsInPorts <span class="hljs-keyword">and</span> outputMap? <span class="hljs-keyword">and</span> <span class="hljs-keyword">typeof</span> outputMap <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span> <span class="hljs-keyword">and</span> Object.keys(outputMap).indexOf(port) <span class="hljs-keyword">isnt</span> <span class="hljs-number">-1</span>
        mapIsInPorts = <span class="hljs-literal">true</span>

    <span class="hljs-keyword">if</span> componentPorts.length <span class="hljs-keyword">is</span> <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> mapIsInPorts
      @sendIP componentPorts[<span class="hljs-number">0</span>], outputMap
      <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">if</span> componentPorts.length &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> mapIsInPorts
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">'Port must be specified for sending output'</span>

    <span class="hljs-keyword">for</span> port, packet <span class="hljs-keyword">of</span> outputMap
      @sendIP port, packet</pre></div>
            
          
            
            <p>Sends the argument via <code>send()</code> and marks activation as <code>done()</code></p>

            
              <div class='highlight'><pre>  sendDone: <span class="hljs-function"><span class="hljs-params">(outputMap)</span> -&gt;</span>
    @send outputMap
    @done()</pre></div>
            
          
            
            <p>Makes a map-style component pass a result value to <code>out</code>
keeping all IP metadata received from <code>in</code>,
or modifying it if <code>options</code> is provided</p>

            
              <div class='highlight'><pre>  pass: <span class="hljs-function"><span class="hljs-params">(data, options = {})</span> -&gt;</span>
    <span class="hljs-keyword">unless</span> <span class="hljs-string">'out'</span> <span class="hljs-keyword">of</span> @ports
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">'output.pass() requires port "out" to be present'</span>
    <span class="hljs-keyword">for</span> key, val <span class="hljs-keyword">of</span> options
      @ip[key] = val
    @ip.data = data
    @sendIP <span class="hljs-string">'out'</span>, @ip
    @done()</pre></div>
            
          
            
            <p>Finishes process activation gracefully</p>

            
              <div class='highlight'><pre>  done: <span class="hljs-function"><span class="hljs-params">(error)</span> -&gt;</span>
    @result.__resolved = <span class="hljs-literal">true</span>
    @nodeInstance.activate @context
    @error error <span class="hljs-keyword">if</span> error
<span class="hljs-function">
    <span class="hljs-title">isLast</span> = =&gt;</span></pre></div>
            
          
            
            <p>We only care about real output sets with processing data</p>

            
              <div class='highlight'><pre>      resultsOnly = @nodeInstance.outputQ.filter (q) -&gt;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">unless</span> q.__resolved
        <span class="hljs-keyword">if</span> Object.keys(q).length <span class="hljs-keyword">is</span> <span class="hljs-number">2</span> <span class="hljs-keyword">and</span> q.__bracketClosingAfter
          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        <span class="hljs-literal">true</span>
      pos = resultsOnly.indexOf @result
      len = resultsOnly.length
      load = @nodeInstance.load
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">if</span> pos <span class="hljs-keyword">is</span> len - <span class="hljs-number">1</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">if</span> pos <span class="hljs-keyword">is</span> <span class="hljs-number">-1</span> <span class="hljs-keyword">and</span> load <span class="hljs-keyword">is</span> len + <span class="hljs-number">1</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">if</span> len &lt;= <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> load <span class="hljs-keyword">is</span> <span class="hljs-number">1</span>
      <span class="hljs-literal">false</span>
    <span class="hljs-keyword">if</span> @nodeInstance.isOrdered() <span class="hljs-keyword">and</span> isLast()</pre></div>
            
          
            
            <p>We’re doing bracket forwarding. See if there are
dangling closeBrackets in buffer since we’re the
last running process function.</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">for</span> port, contexts <span class="hljs-keyword">of</span> @nodeInstance.bracketContext.<span class="hljs-keyword">in</span>
        <span class="hljs-keyword">continue</span> <span class="hljs-keyword">unless</span> contexts[@scope]
        nodeContext = contexts[@scope]
        <span class="hljs-keyword">continue</span> <span class="hljs-keyword">unless</span> nodeContext.length
        context = nodeContext[nodeContext.length - <span class="hljs-number">1</span>]
        buf = @nodeInstance.inPorts[context.source].getBuffer context.ip.scope, context.ip.index
        <span class="hljs-keyword">loop</span>
          <span class="hljs-keyword">break</span> <span class="hljs-keyword">unless</span> buf.length
          <span class="hljs-keyword">break</span> <span class="hljs-keyword">unless</span> buf[<span class="hljs-number">0</span>].type <span class="hljs-keyword">is</span> <span class="hljs-string">'closeBracket'</span>
          ip = @nodeInstance.inPorts[context.source].get context.ip.scope, context.ip.index
          ctx = nodeContext.pop()
          ctx.closeIp = ip
          @result.__bracketClosingAfter = [] <span class="hljs-keyword">unless</span> @result.__bracketClosingAfter
          @result.__bracketClosingAfter.push ctx

    debug <span class="hljs-string">"<span class="hljs-subst">#{@nodeInstance.nodeId}</span> finished processing <span class="hljs-subst">#{@nodeInstance.load}</span>"</span>

    @nodeInstance.deactivate @context</pre></div>
            
          
          <p><small>This page contains documentation generated automatically on 2017-03-01 from NoFlo's <a href="https://github.com/noflo/noflo/blob/master/src/lib/Component.coffee">Component.coffee</a> file.</small></p>
        </div>
      </div>
    </div>
  </div>
